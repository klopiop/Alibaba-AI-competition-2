# é˜¿é‡Œäº‘ ESA Pages + å‡½æ•°è®¡ç®— æ··åˆéƒ¨ç½²æ–¹æ¡ˆ

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®å·²é…ç½®ä¸ºæ”¯æŒé˜¿é‡Œäº‘ ESA Pagesï¼ˆé™æ€å‰ç«¯ï¼‰+ å‡½æ•°è®¡ç®—ï¼ˆåç«¯ APIï¼‰çš„æ··åˆéƒ¨ç½²æ¶æ„ã€‚

## ğŸ—ï¸ æ¶æ„è¯´æ˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·è¯·æ±‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ESA Pages (é™æ€å‰ç«¯)                      â”‚
â”‚  - Next.js é™æ€å¯¼å‡º                                      â”‚
â”‚  - HTML/CSS/JS å…¨çƒè¾¹ç¼˜åˆ†å‘                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         é˜¿é‡Œäº‘å‡½æ•°è®¡ç®— (åç«¯ API)                     â”‚
â”‚  - /api/auth/* - è®¤è¯ API                                â”‚
â”‚  - /api/chat - Chat API                                   â”‚
â”‚  - /api/admin/* - ç®¡ç† API                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          é˜¿é‡Œäº‘ RDS MySQL (æ•°æ®åº“)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
.
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ ESA_DEPLOYMENT_GUIDE.md    # è¯¦ç»†éƒ¨ç½²æŒ‡å—
â”œâ”€â”€ functions/                        # å‡½æ•°è®¡ç®—åç«¯ä»£ç 
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ chat/
â”‚   â”‚   â”‚   â””â”€â”€ index.ts          # Chat API
â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”‚   â”œâ”€â”€ login.ts          # ç™»å½• API
â”‚   â”‚   â”‚   â””â”€â”€ register.ts       # æ³¨å†Œ API
â”‚   â”‚   â”œâ”€â”€ admin/
â”‚   â”‚   â”‚   â””â”€â”€ export.ts         # å¯¼å‡º API
â”‚   â”‚   â””â”€â”€ lib/
â”‚   â”‚       â”œâ”€â”€ prisma.ts         # Prisma å®¢æˆ·ç«¯
â”‚   â”‚       â””â”€â”€ auth.ts           # è®¤è¯é€»è¾‘
â”‚   â”œâ”€â”€ prisma/
â”‚   â”‚   â””â”€â”€ schema.prisma           # æ•°æ®åº“æ¨¡å‹
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ tsconfig.json
â”‚   â””â”€â”€ .env.example
â”œâ”€â”€ src/                              # Next.js å‰ç«¯ä»£ç 
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â””â”€â”€ api.ts              # API å®¢æˆ·ç«¯
â”‚   â””â”€â”€ app/
â”œâ”€â”€ next.config.ts                    # Next.js é…ç½®ï¼ˆå·²ä¿®æ”¹ä¸ºé™æ€å¯¼å‡ºï¼‰
â”œâ”€â”€ package.json
â””â”€â”€ .env.production                   # ç”Ÿäº§ç¯å¢ƒå˜é‡
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®æ¡ä»¶

1. âœ… é˜¿é‡Œäº‘è´¦å·
2. âœ… å¼€é€š ESA è¾¹ç¼˜å®‰å…¨åŠ é€Ÿ
3. âœ… å¼€é€š"å‡½æ•°å’Œ Pages"æœåŠ¡
4. âœ… GitHub ä»“åº“

### éƒ¨ç½²æ­¥éª¤

#### é˜¶æ®µ 1ï¼šå‡†å¤‡ä»£ç 

```bash
# 1. å…‹éš†æˆ–åˆå§‹åŒ– Git ä»“åº“
git init
git add .
git commit -m "Initial commit for ESA deployment"

# 2. æ¨é€åˆ° GitHub
git remote add origin https://github.com/your-username/your-repo.git
git push -u origin main
```

#### é˜¶æ®µ 2ï¼šéƒ¨ç½²å‰ç«¯åˆ° ESA Pages

1. ç™»å½•é˜¿é‡Œäº‘æ§åˆ¶å°
2. è¿›å…¥ **è¾¹ç¼˜å®‰å…¨åŠ é€Ÿ ESA** â†’ **å‡½æ•°å’Œ Pages** â†’ **Pages**
3. ç‚¹å‡» **åˆ›å»ºé¡¹ç›®**
4. é€‰æ‹© **GitHub** ä»“åº“å¹¶æˆæƒ
5. é…ç½®æ„å»ºè®¾ç½®ï¼š
   ```
   æ¡†æ¶ï¼šNext.js
   æ„å»ºå‘½ä»¤ï¼šnpm run build
   è¾“å‡ºç›®å½•ï¼š./out
   Node.js ç‰ˆæœ¬ï¼š20
   å®‰è£…å‘½ä»¤ï¼špnpm install
   ```
6. é…ç½®ç¯å¢ƒå˜é‡ï¼š
   ```env
   NEXT_PUBLIC_API_BASE_URL=https://your-function-endpoint.aliyuncs.com
   NEXTAUTH_SECRET=your_production_secret
   NEXTAUTH_URL=https://your-pages-domain.aliyuncs.com
   ```
7. ç‚¹å‡» **éƒ¨ç½²**

#### é˜¶æ®µ 3ï¼šåˆ›å»ºé˜¿é‡Œäº‘ RDS æ•°æ®åº“

1. è¿›å…¥ **äº‘æ•°æ®åº“ RDS** æ§åˆ¶å°
2. åˆ›å»º **MySQL 8.0** å®ä¾‹
3. é…ç½®ç™½åå•ï¼ˆå…è®¸å‡½æ•°è®¡ç®—è®¿é—®ï¼‰
4. è·å–è¿æ¥å­—ç¬¦ä¸²ï¼š
   ```env
   DATABASE_URL="mysql://username:password@rm-xxxxx.mysql.rds.aliyuncs.com:3306/dbname"
   ```

#### é˜¶æ®µ 4ï¼šéƒ¨ç½²å‡½æ•°è®¡ç®—

1. è¿›å…¥ **å‡½æ•°è®¡ç®— FC** æ§åˆ¶å°
2. åˆ›å»º **æœåŠ¡**ï¼š`esa-backend-service`
3. åˆ›å»º **å‡½æ•°**ï¼ˆæ¯ä¸ª API ä¸€ä¸ªå‡½æ•°ï¼‰ï¼š
   - `chat-function`ï¼šå¤„ç† /api/chat
   - `auth-login-function`ï¼šå¤„ç† /api/auth/login
   - `auth-register-function`ï¼šå¤„ç† /api/auth/register
   - `admin-export-function`ï¼šå¤„ç† /api/admin/export

4. é…ç½®å‡½æ•°ï¼ˆä»¥ chat-function ä¸ºä¾‹ï¼‰ï¼š
   ```json
   {
     "handler": "index.handler",
     "runtime": "nodejs20",
     "memorySize": 512,
     "timeout": 60,
     "environmentVariables": {
       "DATABASE_URL": "mysql://...",
       "OPENAI_API_KEY": "sk-...",
       "OPENAI_MODEL": "gpt-4o-mini",
       "NEXTAUTH_SECRET": "your_secret",
       "NEXTAUTH_URL": "https://your-pages-domain.aliyuncs.com"
     }
   }
   ```

5. é…ç½® HTTP è§¦å‘å™¨ï¼š
   - è®¤è¯æ–¹å¼ï¼šåŒ¿å
   - è¯·æ±‚æ–¹å¼ï¼šPOST
   - è·¯å¾„ï¼š`/api/chat`

6. é…ç½®è‡ªå®šä¹‰åŸŸåå’Œè·¯ç”±è§„åˆ™

#### é˜¶æ®µ 5ï¼šæ•°æ®åº“è¿ç§»

```bash
# è¿›å…¥ functions ç›®å½•
cd functions

# å®‰è£…ä¾èµ–
pnpm install

# ç”Ÿæˆ Prisma å®¢æˆ·ç«¯
pnpm prisma generate

# æ¨é€è¿ç§»
pnpm prisma migrate deploy
```

## ğŸ“ ç¯å¢ƒå˜é‡é…ç½®

### å‰ç«¯ï¼ˆ.env.productionï¼‰

```env
# API åŸºç¡€ URLï¼ˆæŒ‡å‘å‡½æ•°è®¡ç®—ï¼‰
NEXT_PUBLIC_API_BASE_URL=https://your-function-endpoint.aliyuncs.com

# OpenAI API é…ç½®ï¼ˆå…¼å®¹ OpenAI æ ‡å‡†æ ¼å¼ï¼‰
# æ”¯æŒè‡ªå®šä¹‰ API URLï¼ˆä¾‹å¦‚ï¼šOpenAIã€Azure OpenAIã€æˆ–å…¶ä»–å…¼å®¹æœåŠ¡ï¼‰
OPENAI_API_KEY=your_openai_api_key
OPENAI_API_URL=https://api.openai.com/v1/chat/completions
OPENAI_MODEL=gpt-4o-mini

# NextAuth é…ç½®
NEXTAUTH_SECRET=your_production_secret
NEXTAUTH_URL=https://your-pages-domain.aliyuncs.com
```

### åç«¯ï¼ˆfunctions/.envï¼‰

```env
# æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²
DATABASE_URL="mysql://username:password@rm-xxxxx.mysql.rds.aliyuncs.com:3306/dbname"

# OpenAI API é…ç½®ï¼ˆå…¼å®¹ OpenAI æ ‡å‡†æ ¼å¼ï¼‰
# æ”¯æŒè‡ªå®šä¹‰ API URLï¼ˆä¾‹å¦‚ï¼šOpenAIã€Azure OpenAIã€æˆ–å…¶ä»–å…¼å®¹æœåŠ¡ï¼‰
OPENAI_API_KEY=sk-your-openai-api-key
OPENAI_API_URL=https://api.openai.com/v1/chat/completions
OPENAI_MODEL=gpt-4o-mini

# NextAuth é…ç½®
NEXTAUTH_SECRET=your-production-secret-key-change-me
NEXTAUTH_URL=https://your-pages-domain.aliyuncs.com

# è¿è¡Œç¯å¢ƒ
NODE_ENV=production
```

## ğŸ”§ å¼€å‘è°ƒè¯•

### æœ¬åœ°å¼€å‘

```bash
# å‰ç«¯å¼€å‘
npm run dev

# åç«¯å¼€å‘ï¼ˆåœ¨ functions ç›®å½•ï¼‰
cd functions
pnpm dev
```

### æµ‹è¯• API

```bash
# æµ‹è¯•ç™»å½•
curl -X POST https://your-function-endpoint.aliyuncs.com/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password"}'

# æµ‹è¯• Chat API
curl -X POST https://your-function-endpoint.aliyuncs.com/api/chat \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"type":"oracle","messages":[{"role":"user","content":"Hello"}],"locale":"zh"}'
```

## ğŸ’° æˆæœ¬ä¼°ç®—

### ESA Pages
- **å…è´¹é¢åº¦**ï¼šæ¯æœˆ 10GB æµé‡
- **è¶…å‡ºè´¹ç”¨**ï¼šÂ¥0.5/GB
- **å­˜å‚¨**ï¼šÂ¥0.005/GB/æœˆ

### å‡½æ•°è®¡ç®—
- **å…è´¹é¢åº¦**ï¼šæ¯æœˆ 100ä¸‡æ¬¡è°ƒç”¨
- **è¶…å‡ºè´¹ç”¨**ï¼šÂ¥1.33/ç™¾ä¸‡æ¬¡
- **å†…å­˜**ï¼š512MB Â¥0.000031/GBç§’

### RDS MySQL
- **å®ä¾‹**ï¼š2æ ¸4GB èµ·æ­¥çº¦ Â¥200/æœˆ
- **å­˜å‚¨**ï¼šÂ¥0.007/GB/æœˆ

**æœˆåº¦é¢„ä¼°**ï¼šçº¦ Â¥300-500ï¼ˆä¸­å°è§„æ¨¡ï¼‰

## ğŸ”’ å®‰å…¨å»ºè®®

1. âœ… å¯ç”¨ HTTPS
2. âœ… ä½¿ç”¨å¼ºå¯†ç å’Œ JWT è®¤è¯
3. âœ… é…ç½® RDS ç™½åå•
4. âœ… å®ç°é€Ÿç‡é™åˆ¶
5. âœ… éªŒè¯æ‰€æœ‰ç”¨æˆ·è¾“å…¥
6. âœ… å®šæœŸå¤‡ä»½æ•°æ®åº“
7. âœ… ç›‘æ§å¼‚å¸¸è®¿é—®

## ğŸ“š ç›‘æ§ä¸æ—¥å¿—

### ESA Pages ç›‘æ§
- è®¿é—®æ—¥å¿—
- é”™è¯¯æ—¥å¿—
- æ€§èƒ½æŒ‡æ ‡

### å‡½æ•°è®¡ç®—ç›‘æ§
- è°ƒç”¨æ¬¡æ•°
- å¹³å‡æ‰§è¡Œæ—¶é—´
- é”™è¯¯ç‡
- èµ„æºä½¿ç”¨

### RDS ç›‘æ§
- è¿æ¥æ•°
- QPS
- æ…¢æŸ¥è¯¢æ—¥å¿—

## â“ æ•…éšœæ’æŸ¥

### Pages éƒ¨ç½²å¤±è´¥
- æ£€æŸ¥æ„å»ºæ—¥å¿—
- ç¡®è®¤ [`next.config.ts`](next.config.ts:1) é…ç½®
- éªŒè¯ä¾èµ–ç‰ˆæœ¬

### å‡½æ•°è°ƒç”¨å¤±è´¥
- æ£€æŸ¥å‡½æ•°æ—¥å¿—
- éªŒè¯ç¯å¢ƒå˜é‡
- ç¡®è®¤æ•°æ®åº“è¿æ¥

### CORS é”™è¯¯
- æ£€æŸ¥å‡½æ•°ä¸­çš„ CORS å¤´é…ç½®
- éªŒè¯ HTTP è§¦å‘å™¨è®¾ç½®

## ğŸ“š è¯¦ç»†æ–‡æ¡£

å®Œæ•´çš„éƒ¨ç½²æŒ‡å—è¯·å‚è€ƒï¼š[`docs/ESA_DEPLOYMENT_GUIDE.md`](docs/ESA_DEPLOYMENT_GUIDE.md)

## ğŸ¤ æŠ€æœ¯æ”¯æŒ

- [ESA Pages æ–‡æ¡£](https://help.aliyun.com/zh/edge-security-acceleration/esa/user-guide/what-is-functions-and-pages/)
- [å‡½æ•°è®¡ç®—æ–‡æ¡£](https://help.aliyun.com/zh/functioncompute/)
- [RDS æ–‡æ¡£](https://help.aliyun.com/zh/rds/)
- [Next.js é™æ€å¯¼å‡º](https://nextjs.org/docs/app/building-your-application/deploying/static-exports)
